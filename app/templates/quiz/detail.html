{% extends 'base.html' %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-8">

        <div class="detail-header">
            <div>
                <h4>{{ quiz.title }}</h4>
                <p>{{ quiz.description or 'No description' }}</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
                {% if quiz.creator_id == current_user.id %}
                <a href="{{ url_for('quiz.edit_quiz', code=quiz.code) }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <form method="POST" action="{{ url_for('quiz.delete_quiz', code=quiz.code) }}"
                    onsubmit="return confirm('Are you sure you want to delete this quiz?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ quiz.questions|length }}</div>
                    <div class="stat-label">Questions</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ quiz.attempts|length }}</div>
                    <div class="stat-label">Attempts</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ quiz.time_limit or 'No' }}</div>
                    <div class="stat-label">Time Limit</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-number">{{ quiz.user_limit or 'Open' }}</div>
                    <div class="stat-label">User Limit</div>
                </div>
            </div>
        </div>

        <div class="share-card">
            <h6><i class="bi bi-share me-2"></i>Share this Quiz</h6>
            <label class="form-label">Quiz Code</label>
            <div class="quiz-code-display">{{ quiz.code }}</div>
            <label class="form-label">Shareable Link</label>
            <div class="input-group">
                <input type="text" class="form-control" id="quiz-link"
                    value="{{ url_for('quiz.take_quiz', code=quiz.code, _external=True) }}" readonly>
                <button class="btn btn-primary" onclick="copyLink()">
                    <i class="bi bi-clipboard me-1"></i>Copy
                </button>
            </div>
            <div class="copy-msg" id="copy-msg">
                <i class="bi bi-check me-1"></i>Link copied!
            </div>
        </div>

        <div class="questions-section">
            <h6>Questions</h6>
            {% for question in quiz.questions %}
            <div class="question-item">
                <span class="question-badge">Q{{ loop.index }}</span>
                <span class="fw-600" style="font-size:0.95rem;">{{ question.text }}</span>
                <div class="mt-2">
                    {% for option in question.options %}
                    <span class="option-badge {% if option.is_correct %}option-correct{% else %}option-wrong{% endif %}">
                        {% if option.is_correct %}<i class="bi bi-check me-1"></i>{% endif %}
                        {{ option.text }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

    </div>

    <div class="col-md-4">
        <div class="leaderboard-card">
            <h6><i class="bi bi-trophy me-2"></i>Leaderboard</h6>
            {% if quiz.attempts %}
            {% for attempt in quiz.attempts|sort(attribute='score', reverse=True) %}
            <div class="leaderboard-item">
                <span class="leaderboard-rank
                    {% if loop.index == 1 %}rank-1
                    {% elif loop.index == 2 %}rank-2
                    {% else %}rank-other{% endif %}">
                    #{{ loop.index }}
                </span>
                <div>
                    <div class="leaderboard-name">{{ attempt.user.name }}</div>
                    <div class="leaderboard-date">{{ attempt.started_at.strftime('%d %b') }}</div>
                </div>
                <span class="leaderboard-score">
                    {{ attempt.score|int }}/{{ attempt.total|int }}
                </span>
            </div>
            {% endfor %}
            {% else %}
            <div class="leaderboard-empty">No attempts yet</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copyLink() {
    const link = document.getElementById('quiz-link').value;
    navigator.clipboard.writeText(link);
    const msg = document.getElementById('copy-msg');
    msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 2000);
}
</script>
{% endblock %}